<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>SIDCF - Diagnostic Complet</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
    .log { margin: 4px 0; padding: 4px 8px; border-left: 3px solid #666; }
    .log.success { border-color: #4ec9b0; color: #4ec9b0; }
    .log.error { border-color: #f48771; color: #f48771; background: #3f1f1f; }
    .log.info { border-color: #569cd6; color: #569cd6; }
    .log.warn { border-color: #dcdcaa; color: #dcdcaa; }
    h1 { color: #4ec9b0; }
    .timestamp { color: #808080; font-size: 0.9em; }
  </style>
</head>
<body>
  <h1>üîç SIDCF Portal - Diagnostic Complet</h1>
  <div id="logs"></div>

  <script type="module">
    const logsEl = document.getElementById('logs');

    function log(message, type = 'info') {
      const timestamp = new Date().toISOString().split('T')[1].slice(0, 12);
      const div = document.createElement('div');
      div.className = `log ${type}`;
      div.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
      logsEl.appendChild(div);
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    async function runDiagnostic() {
      log('üöÄ D√©marrage du diagnostic...', 'info');

      try {
        // Test 1: Import lib/dom.js
        log('Test 1: Import lib/dom.js', 'info');
        const domModule = await import('./js/lib/dom.js');
        log('‚úì lib/dom.js charg√© - exports: ' + Object.keys(domModule).join(', '), 'success');

        // Test 2: Import lib/logger.js
        log('Test 2: Import lib/logger.js', 'info');
        const loggerModule = await import('./js/lib/logger.js');
        log('‚úì lib/logger.js charg√©', 'success');

        // Test 3: Import router.js
        log('Test 3: Import router.js', 'info');
        const routerModule = await import('./js/router.js');
        log('‚úì router.js charg√©', 'success');

        // Test 4: Import datastore/data-service.js
        log('Test 4: Import datastore/data-service.js', 'info');
        const dataServiceModule = await import('./js/datastore/data-service.js');
        log('‚úì data-service.js charg√©', 'success');

        // Test 5: Initialize dataService
        log('Test 5: Initialisation dataService', 'info');
        await dataServiceModule.default.init();
        log('‚úì dataService initialis√©', 'success');

        // Test 6: Import widgets
        log('Test 6: Import widgets/cle-repartition-manager.js', 'info');
        const cleWidget = await import('./js/ui/widgets/cle-repartition-manager.js');
        log('‚úì cle-repartition-manager.js charg√© - exports: ' + Object.keys(cleWidget).join(', '), 'success');

        log('Test 7: Import widgets/echeancier-manager.js', 'info');
        const echWidget = await import('./js/ui/widgets/echeancier-manager.js');
        log('‚úì echeancier-manager.js charg√© - exports: ' + Object.keys(echWidget).join(', '), 'success');

        // Test 8: Test widget rendering
        log('Test 8: Test renderCleRepartitionManager()', 'info');
        const testCleWidget = cleWidget.renderCleRepartitionManager([], 0, 0, {}, null);
        log('‚úì Widget cr√©√©: ' + testCleWidget.tagName + ', classes: ' + testCleWidget.className, 'success');

        log('Test 9: Test renderEcheancierManager()', 'info');
        const testEchWidget = echWidget.renderEcheancierManager(null, [], 0, {}, null);
        log('‚úì Widget cr√©√©: ' + testEchWidget.tagName + ', classes: ' + testEchWidget.className, 'success');

        // Test 10: Import screen ecr03a-attribution.js
        log('Test 10: Import screens/ecr03a-attribution.js', 'info');
        const attrModule = await import('./js/modules/marche/screens/ecr03a-attribution.js');
        log('‚úì ecr03a-attribution.js charg√©', 'success');
        log('  - renderAttribution: ' + (typeof attrModule.renderAttribution), 'info');
        log('  - default export: ' + (typeof attrModule.default), 'info');

        // Test 11: Import screen ecr04a-visa-cf.js
        log('Test 11: Import screens/ecr04a-visa-cf.js', 'info');
        const visaModule = await import('./js/modules/marche/screens/ecr04a-visa-cf.js');
        log('‚úì ecr04a-visa-cf.js charg√©', 'success');
        log('  - renderVisaCF: ' + (typeof visaModule.renderVisaCF), 'info');
        log('  - default export: ' + (typeof visaModule.default), 'info');

        // Test 12: Import module marche/index.js
        log('Test 12: Import modules/marche/index.js', 'info');
        const marcheModule = await import('./js/modules/marche/index.js');
        log('‚úì marche/index.js charg√©', 'success');
        log('  - registerMarcheRoutes: ' + (typeof marcheModule.registerMarcheRoutes), 'info');

        // Test 13: Import main.js
        log('Test 13: Import main.js', 'info');
        const mainModule = await import('./js/main.js');
        log('‚úì main.js charg√©', 'success');

        log('', 'info');
        log('üéâ TOUS LES TESTS R√âUSSIS !', 'success');
        log('L\'application devrait pouvoir d√©marrer normalement.', 'success');
        log('', 'info');
        log('üëâ Essayez de recharger l\'application principale avec Cmd+Shift+R', 'warn');

      } catch (error) {
        log('', 'error');
        log('‚ùå ERREUR D√âTECT√âE:', 'error');
        log('Message: ' + error.message, 'error');
        log('', 'error');
        if (error.stack) {
          log('Stack trace:', 'error');
          error.stack.split('\n').forEach(line => {
            log('  ' + line, 'error');
          });
        }
      }
    }

    runDiagnostic();
  </script>
</body>
</html>
